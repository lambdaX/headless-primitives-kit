<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESM HeadlessButton Example</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        #app { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button {
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button[data-focused="true"] { box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.5); }
        button[data-pressed="true"] { background-color: #004085; }
        .log-area { margin-top: 20px; padding: 10px; background-color: #e9ecef; border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 0.9em; }
        .log-area p { margin: 2px 0; border-bottom: 1px solid #ddd; padding-bottom: 2px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .controls label { display: flex; align-items: center; gap: 5px; }
        .state-display { margin-top: 10px; padding: 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="app">
        <h2>HeadlessButton ESM Example</h2>
        <p>This example demonstrates using the HeadlessButton component directly via ESM modules from a CDN, with React for rendering.</p>
        <div id="button-container"></div>
        <div class="controls">
            <button id="btnToggleDisabled">Toggle Disabled</button>
            <button id="btnToggleLoading">Toggle Loading</button>
            <button id="btnSetError">Set Error</button>
            <button id="btnUndo">Undo</button>
            <button id="btnRedo">Redo</button>
        </div>
        <div id="state-inspector" class="state-display">Inspecting state...</div>
        <div class="log-area" id="log-output">Logs will appear here...</div>
    </div>

    <script type="module">
        const logOutput = document.getElementById('log-output');
        const stateInspector = document.getElementById('state-inspector');

        function log(message) {
            console.log(message);
            const p = document.createElement('p');
            p.textContent = \`[\${new Date().toLocaleTimeString()}] \${message}\`;
            logOutput.insertBefore(p, logOutput.firstChild);
        }

        async function main() {
            try {
                log("Attempting to load React...");
                const ReactModule = await import('https://esm.sh/react@18.3.1');
                window.React = ReactModule.default || ReactModule;
                log("React loaded.");

                log("Attempting to load ReactDOM...");
                const ReactDOMModule = await import('https://esm.sh/react-dom@18.3.1/client');
                window.ReactDOM = ReactDOMModule.default || ReactDOMModule;
                log("ReactDOM loaded.");

                const basePath = 'https://cdn.jsdelivr.net/gh/lambdaX/headless-primitives-kit@master/dist';
                log(\`Base path for headless-primitives-kit: \${basePath}\`);

                log("Attempting to load HeadlessButton...");
                const { HeadlessButton } = await import(\`\${basePath}/components/headless-logic/headless-button.js\`);
                log("HeadlessButton loaded.");

                log("Attempting to load useHeadlessComponent...");
                const { useHeadlessComponent } = await import(\`\${basePath}/hooks/use-headless-component.js\`);
                log("useHeadlessComponent loaded.");
                
                if (!window.React) throw new Error("React not loaded on window");
                if (!window.ReactDOM) throw new Error("ReactDOM not loaded on window");
                if (!HeadlessButton) throw new Error("HeadlessButton not loaded");
                if (!useHeadlessComponent) throw new Error("useHeadlessComponent not loaded");

                const { useEffect, useState, useMemo, useCallback } = window.React;

                function MyStyledButton() {
                    const { component, componentState, cssState, history, undo, redo } = useHeadlessComponent(HeadlessButton);

                    useEffect(() => {
                        const handleStateChange = () => {
                            const inspectorText = \`Component State: \${JSON.stringify(componentState, null, 2)}\\nCSS State: \${JSON.stringify(cssState, null, 2)}\\nHistory: \${JSON.stringify(history, null, 2)}\`;
                            stateInspector.textContent = inspectorText;
                            log(\`State updated: IsDisabled=\${componentState.isDisabled}, IsLoading=\${componentState.isLoading}, Error=\${componentState.error}\`);
                        };
                        handleStateChange(); // Initial update
                        const unsubState = component.subscribe('stateChanged', handleStateChange);
                        const unsubCss = component.subscribe('cssStateChanged', handleStateChange);
                        const unsubHistory = component.subscribe('historyChanged', handleStateChange);
                        return () => { unsubState(); unsubCss(); unsubHistory(); };
                    }, [component, componentState, cssState, history]);


                    document.getElementById('btnToggleDisabled').onclick = () => component.setDisabled(!component.getState().isDisabled);
                    document.getElementById('btnToggleLoading').onclick = () => component.setLoading(!component.getState().isLoading);
                    document.getElementById('btnSetError').onclick = () => component.setError(component.getState().error ? null : "Sample Error!");
                    document.getElementById('btnUndo').onclick = () => undo();
                    document.getElementById('btnRedo').onclick = () => redo();


                    return React.createElement('button', {
                        type: 'button',
                        onClick: (e) => component.click(e),
                        onMouseEnter: (e) => component.hover(true, e),
                        onMouseLeave: (e) => component.hover(false, e),
                        onFocus: (e) => component.focus(true, e),
                        onBlur: (e) => component.focus(false, e),
                        onKeyDown: (e) => component.keydown(e.nativeEvent),
                        onMouseDown: () => component.press(true),
                        onMouseUp: () => component.press(false),
                        disabled: componentState.isDisabled || componentState.isLoading,
                        'data-disabled': componentState.isDisabled,
                        'data-loading': componentState.isLoading,
                        'data-error': componentState.error ? 'true' : undefined,
                        'data-focused': componentState.isFocused,
                        'data-hovered': componentState.isHovered,
                        'data-pressed': componentState.isPressed,
                        className: cssState.classes.join(' '),
                        style: {
                            backgroundColor: componentState.isDisabled ? '#ccc' : 
                                             componentState.isLoading ? '#aec6cf' : 
                                             componentState.error ? '#ffdddd' :
                                             componentState.isPressed ? '#003366' :
                                             componentState.isFocused ? '#add8e6' :
                                             componentState.isHovered ? '#0056b3' : '#007bff',
                            color: componentState.error ? '#a00' : 'white',
                            border: componentState.error ? '1px solid #a00' : '1px solid #ddd',
                        }
                    }, componentState.isLoading ? 'Loading...' : componentState.error ? 'Error!' : 'Click Me (ESM)');
                }

                const container = document.getElementById('button-container');
                const root = window.ReactDOM.createRoot(container);
                root.render(React.createElement(MyStyledButton));
                log("React component rendered.");

            } catch (error) {
                log(\`ERROR in main(): \${error.message}\`);
                console.error("Detailed error:", error);
                stateInspector.textContent = \`Failed to load component: \${error.message}\`;
            }
        }
        main();
    </script>
</body>
</html>
