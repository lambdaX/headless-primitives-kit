<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeadlessButton ESM Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; display: flex; flex-direction: column; align-items: center; }
        #app { margin-top: 20px; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button {
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
            transition: background-color 0.2s;
            min-width: 120px;
        }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        button.loading { opacity: 0.7; }
        button.hovered { background-color: #e0e0e0; }
        button.focused { outline: 2px solid blue; outline-offset: 2px; }
        button.pressed { background-color: #d0d0d0; }
        .error { border-color: red; background-color: #ffe0e0; }
        .controls { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .state-display { margin-top:15px; padding:10px; border:1px solid #eee; border-radius:4px; background-color:#f9f9f9; font-size:0.9em; white-space:pre-wrap; }
        .log-area { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #fff; width: 100%; max-width: 600px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.8em; }
        .info { font-size: 0.8em; color: #555; margin-top: 10px; text-align: center; }
        .troubleshooting { margin-top: 20px; padding: 10px; border: 1px dashed #aaa; background-color: #f0f0f0; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>HeadlessButton ESM Example (via CDN)</h1>
    <p>This example demonstrates using the <code>HeadlessButton</code> component directly in an HTML file via CDN (jsDelivr).</p>
    <p>It imports React, ReactDOM, and the headless component logic from their respective CDN URLs.</p>

    <div id="app">
        <!-- React app will be rendered here -->
        <p>Loading component...</p>
    </div>

    <div class="log-area" id="logArea">
        <strong>Console Log:</strong><br>
    </div>

    <div class="info">
        Check your browser's developer console (F12) for more detailed logs and potential errors.
    </div>

    <div class="troubleshooting">
        <strong>Troubleshooting 404s (File Not Found):</strong>
        <ul>
            <li>Ensure the GitHub Action "Build and Deploy Headless Logic" (main.yml) has completed successfully after the latest push to <code>master</code>. This action builds and commits the <code>dist</code> folder.</li>
            <li>Check the <code>master</code> branch on GitHub to verify that the <code>dist</code> folder contains the expected JavaScript files (e.g., <code>dist/components/headless-logic/headless-button.js</code>, <code>dist/hooks/use-headless-component.js</code>).</li>
            <li>jsDelivr caches files. It might take a few minutes for the latest version to propagate after a new commit to <code>master</code>.</li>
            <li>Verify the GitHub Pages deployment "Deploy to GitHub Pages" (gh-pages.yml) succeeded and this HTML file itself is up-to-date.</li>
        </ul>
    </div>


    <script type="module">
        const logArea = document.getElementById('logArea');
        function log(message) {
            console.log(message);
            const entry = document.createElement('div');
            entry.textContent = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function main() {
            try {
                log('Attempting to load React...');
                const ReactModule = await import('https://esm.sh/react@18.3.1');
                window.React = ReactModule.default; // esm.sh typically exports React as default
                if (!window.React) window.React = ReactModule; // Fallback if not default
                log('React loaded.');

                log('Attempting to load ReactDOM...');
                const ReactDOMModule = await import('https://esm.sh/react-dom@18.3.1/client');
                window.ReactDOM = ReactDOMModule; // esm.sh exports createRoot etc. in the module itself.
                log('ReactDOM loaded.');

                const basePath = 'https://cdn.jsdelivr.net/gh/lambdaX/headless-primitives-kit@master/dist';
                log(`Base path for headless-primitives-kit: ${basePath}`);

                log('Attempting to load HeadlessComponent base classes...');
                // These are dependencies of HeadlessButton and useHeadlessComponent
                await import(`${basePath}/components/headless-logic/event-emitter.js`);
                await import(`${basePath}/components/headless-logic/command.js`);
                await import(`${basePath}/components/headless-logic/component-states.js`);
                await import(`${basePath}/components/headless-logic/interaction-strategies.js`);
                await import(`${basePath}/components/headless-logic/headless-component.js`);
                log('HeadlessComponent base loaded.');

                log('Attempting to load HeadlessButton...');
                const { HeadlessButton } = await import(`${basePath}/components/headless-logic/headless-button.js`);
                log('HeadlessButton loaded.');

                log('Attempting to load useHeadlessComponent hook...');
                const { useHeadlessComponent } = await import(`${basePath}/hooks/use-headless-component.js`);
                log('useHeadlessComponent hook loaded.');

                const { useEffect, useState, useMemo, useCallback } = window.React;

                function MyButtonComponent() {
                    const { component, componentState, cssState, history, undo, redo } = useHeadlessComponent(HeadlessButton);

                    useEffect(() => {
                        const handleStateChange = (event, data) => log(\`State changed (\${event}): \${JSON.stringify(data)}\`);
                        const unsubscribe = component.subscribe('stateChanged', handleStateChange);
                        return () => unsubscribe();
                    }, [component]);
                    
                    useEffect(() => {
                        const handleCssChange = (event, data) => log(\`CSS State changed (\${event}): \${JSON.stringify(data)}\`);
                        const unsubscribeCss = component.subscribe('cssStateChanged', handleCssChange);
                        return () => unsubscribeCss();
                    }, [component]);

                    useEffect(() => {
                        const handleHistoryChange = (event, data) => log(\`History changed (\${event}): \${JSON.stringify(data)}\`);
                        const unsubscribeHistory = component.subscribe('historyChanged', handleHistoryChange);
                        return () => unsubscribeHistory();
                    }, [component]);


                    const getButtonText = () => {
                        if (componentState.isLoading) return "Loading...";
                        if (componentState.error) return "Error!";
                        return "Click Me";
                    };
                    
                    const buttonStyle = {
                        backgroundColor: componentState.isPressed ? '#d0d0d0' : componentState.isHovered ? '#e0e0e0' : '#f0f0f0',
                        borderColor: componentState.error ? 'red' : componentState.isFocused ? 'blue' : '#ccc',
                        opacity: componentState.isDisabled || componentState.isLoading ? 0.6 : 1,
                        padding: '10px 15px',
                        borderRadius: '5px',
                        cursor: componentState.isDisabled ? 'not-allowed' : 'pointer',
                        outline: componentState.isFocused ? '2px solid blue' : 'none'
                    };


                    return React.createElement('div', null,
                        React.createElement('button', {
                            type: 'button',
                            style: buttonStyle,
                            className: \`\${cssState.classes.join(' ')} \${componentState.error ? 'error' : ''}\`,
                            onClick: (e) => component.click(e),
                            onMouseEnter: (e) => component.hover(true, e),
                            onMouseLeave: (e) => component.hover(false, e),
                            onFocus: (e) => component.focus(true, e),
                            onBlur: (e) => component.focus(false, e),
                            onKeyDown: (e) => component.keydown(e.nativeEvent),
                            onMouseDown: () => component.press(true),
                            onMouseUp: () => component.press(false),
                            disabled: componentState.isDisabled || componentState.isLoading,
                            ...cssState.dataAttributes
                        }, getButtonText()),
                        React.createElement('div', { className: 'controls' },
                            React.createElement('button', { onClick: () => component.setDisabled(!componentState.isDisabled) }, 'Toggle Disabled'),
                            React.createElement('button', { onClick: () => component.setLoading(!componentState.isLoading) }, 'Toggle Loading'),
                            React.createElement('button', { onClick: () => component.setError(componentState.error ? null : 'Sample Error') }, 'Toggle Error')
                        ),
                        React.createElement('div', { className: 'controls' },
                            React.createElement('button', { onClick: undo, disabled: !history.canUndo }, 'Undo'),
                            React.createElement('button', { onClick: redo, disabled: !history.canRedo }, 'Redo')
                        ),
                        React.createElement('div', {className: 'state-display'},
                            React.createElement('h4', null, 'Live State:'),
                            React.createElement('pre', null, JSON.stringify({ componentState, cssState, history }, null, 2))
                        )
                    );
                }

                const root = ReactDOM.createRoot(document.getElementById('app'));
                root.render(React.createElement(MyButtonComponent));
                log('React component rendered.');

            } catch (error) {
                log('ERROR in main(): ' + error.message);
                const appDiv = document.getElementById('app');
                appDiv.innerHTML = \`<p style="color: red;">Error loading component: \${error.message}. Check console.</p>\`;
                console.error("Detailed error:", error);
            }
        }

        main();
    </script>
</body>
</html>
