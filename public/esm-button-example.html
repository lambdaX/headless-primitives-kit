<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeadlessButton ESM Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; background-color: #f0f0f0; }
        #app { display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
            min-width: 100px;
        }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #e0e0e0; color: #a0a0a0; cursor: not-allowed; }
        button.pressed:not(:disabled) { background-color: #004085; }
        button.error:not(:disabled) { background-color: #dc3545; }
        button.loading:not(:disabled) { background-color: #17a2b8; opacity: 0.8; }
        .controls { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; justify-content: center;}
        .controls label { display: flex; align-items: center; gap: 5px; font-size: 0.9em; }
        .state-display { margin-top: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.8em; white-space: pre-wrap; width: 300px; max-height: 200px; overflow-y: auto; }
        .history-display { font-size: 0.8em; color: #555; }
    </style>
</head>
<body>
    <h1>HeadlessButton ESM Example</h1>
    <div id="app">Loading...</div>

    <script type="module">
        // Import React and ReactDOM from esm.sh (CDN for ES modules)
        const React = await import('https://esm.sh/react@18.2.0');
        const ReactDOM = await import('https://esm.sh/react-dom@18.2.0/client');

        // Import HeadlessButton and its dependencies from your package via unpkg
        // Replace 'lambdaX/headless-primitives-kit@main' with 'your-npm-package-name' if you publish to npm
        // Or use specific commit/tag like 'lambdaX/headless-primitives-kit@your-tag-or-commit'
        const GITHUB_REPO_PATH = 'lambdaX/headless-primitives-kit@main';

        const { HeadlessButton } = await import(`https://unpkg.com/${GITHUB_REPO_PATH}/headless-button`);
        const { HeadlessComponent } = await import(`https://unpkg.com/${GITHUB_REPO_PATH}/headless-component`);
        // ButtonState is part of HeadlessButton export, so it's already available.
        // CssState is part of HeadlessComponent export, so it's also available.
        const { Command, CommandInvoker } = await import(`https://unpkg.com/${GITHUB_REPO_PATH}/command`);
        const { EventEmitter } = await import(`https://unpkg.com/${GITHUB_REPO_PATH}/event-emitter`);
        const { ComponentState, IdleState, HoveredState, FocusedState, PressedState, DisabledState, LoadingState, ErrorState } = await import(`https://unpkg.com/${GITHUB_REPO_PATH}/component-states`);


        // --- Minimal useHeadlessComponent hook implementation for this example ---
        function useHeadlessComponent(HeadlessComponentClass) {
            const component = React.useMemo(() => new HeadlessComponentClass(), [HeadlessComponentClass]);
            const [componentState, setComponentState] = React.useState(component.getState());
            const [cssState, setCssState] = React.useState(component.getCSSState());
            const [history, setHistory] = React.useState(component.getHistory());

            React.useEffect(() => {
                const onStateChanged = (_event, newState) => setComponentState(newState);
                const onCssStateChanged = (_event, newCssState) => setCssState(newCssState);
                const onHistoryChanged = (_event, newHistory) => setHistory(newHistory);
                const onTransition = () => {
                    setComponentState(component.getState());
                    setCssState(component.getCSSState());
                };

                const unsubState = component.subscribe('stateChanged', onStateChanged);
                const unsubCss = component.subscribe('cssStateChanged', onCssStateChanged);
                const unsubHist = component.subscribe('historyChanged', onHistoryChanged);
                const unsubTrans = component.subscribe('stateTransition', onTransition);

                // Initial sync
                onTransition();
                onHistoryChanged(null, component.getHistory());


                return () => {
                    unsubState(); unsubCss(); unsubHist(); unsubTrans();
                };
            }, [component]);

            const undo = React.useCallback(() => component.undo(), [component]);
            const redo = React.useCallback(() => component.redo(), [component]);

            return { component, componentState, cssState, history, undo, redo };
        }
        // --- End of useHeadlessComponent hook ---


        function MyStyledButton() {
            const { component, componentState, cssState, history, undo, redo } = useHeadlessComponent(HeadlessButton);

            const handleClick = (e) => {
                console.log('Button UI clicked');
                component.click(e);
            };
            
            // Basic styling based on state
            let buttonClassName = "";
            if (componentState.isPressed) buttonClassName += " pressed";
            if (componentState.isLoading) buttonClassName += " loading";
            if (componentState.error) buttonClassName += " error";


            return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '10px' } },
                React.createElement('div', { className: 'controls' },
                    React.createElement('label', null,
                        React.createElement('input', {
                            type: 'checkbox',
                            checked: !!componentState.isDisabled,
                            onChange: (e) => component.setDisabled(e.target.checked)
                        }),
                        'Disabled'
                    ),
                    React.createElement('label', null,
                        React.createElement('input', {
                            type: 'checkbox',
                            checked: !!componentState.isLoading,
                            onChange: (e) => component.setLoading(e.target.checked)
                        }),
                        'Loading'
                    ),
                    React.createElement('label', null,
                        React.createElement('input', {
                            type: 'checkbox',
                            checked: !!componentState.error,
                            onChange: (e) => component.setError(e.target.checked ? 'Sample Error' : null)
                        }),
                        'Error'
                    )
                ),
                React.createElement('div', { className: 'controls' },
                    React.createElement('button', { onClick: undo, disabled: !history.canUndo }, 'Undo'),
                    React.createElement('button', { onClick: redo, disabled: !history.canRedo }, 'Redo')
                ),
                React.createElement('button', {
                    type: 'button',
                    onClick: handleClick,
                    onMouseEnter: (e) => component.hover(true, e),
                    onMouseLeave: (e) => component.hover(false, e),
                    onFocus: (e) => component.focus(true, e),
                    onBlur: (e) => component.focus(false, e),
                    onKeyDown: (e) => component.keydown(e),
                    onMouseDown: () => component.press(true),
                    onMouseUp: () => component.press(false),
                    disabled: componentState.isDisabled || componentState.isLoading,
                    'aria-disabled': componentState.isDisabled || componentState.isLoading,
                    className: `${cssState.classes.join(' ')} ${buttonClassName}`,
                    ...cssState.dataAttributes
                }, componentState.isLoading ? 'Loading...' : (componentState.error ? 'Error!' : 'Click Me')),
                React.createElement('div', { className: 'state-display' }, 
                    `Component State:\n${JSON.stringify(componentState, null, 2)}\n\nCSS State:\n${JSON.stringify(cssState, null, 2)}`
                ),
                React.createElement('div', { className: 'history-display' }, `History: ${history.currentPosition + 1} / ${history.length}`)
            );
        }

        // Render the component
        const rootElement = document.getElementById('app');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(React.createElement(MyStyledButton));
        } else {
            console.error('Root element #app not found');
        }

    </script>
</body>
</html>
