
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESM Headless Button Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
        #root { padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #e0e0e0; color: #a0a0a0; cursor: not-allowed; }
        .log-output { margin-top: 20px; padding: 10px; border: 1px solid #eee; background-color: #f9f9f9; max-height: 200px; overflow-y: auto; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>Headless Button ESM Example</h1>
    <p>This example demonstrates loading and using the <code>HeadlessButton</code> and <code>useHeadlessComponent</code> hook directly from ESM modules via a CDN or local server.</p>
    <div id="root"></div>
    <div class="log-output" id="log-output">Logs will appear here...</div>

    <script type="module">
        const logOutput = document.getElementById('log-output');
        function log(message) {
            console.log(message);
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.appendChild(p);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        async function main() {
            try {
                log('Attempting to load React...');
                const ReactModule = await import('https://esm.sh/react@18.2.0');
                window.React = ReactModule.default; // Or specific named exports if needed
                log('ReactModule loaded: ' + ReactModule);
                if (window.React) log('window.React assigned.'); else log('ERROR: window.React NOT assigned.');

                log('Attempting to load ReactDOM...');
                const ReactDOMModule = await import('https://esm.sh/react-dom@18.2.0/client');
                window.ReactDOM = ReactDOMModule; // Or .default if that's the structure
                log('ReactDOMModule loaded: ' + ReactDOMModule);
                if (window.ReactDOM && window.ReactDOM.createRoot) log('ReactDOM assigned.'); else log('ERROR: ReactDOM NOT assigned or createRoot is missing.');

                const urlParams = new URLSearchParams(window.location.search);
                const useLocal = urlParams.get('local') === 'true';
                
                // For Playwright testability
                window.headlessModulesLoaded = false; 


                const basePath = useLocal 
                    ? '../../dist' 
                    : 'https://cdn.jsdelivr.net/gh/lambdaX/headless-primitives-kit@master/dist'; 
                log(`Base path for headless-primitives-kit: ${basePath}`);
                

                log('Attempting to load HeadlessComponent...'); // Prerequisite, though not directly used here.
                // Ensures core dependencies like Command, EventEmitter are tested.
                const HeadlessComponentModule = await import(\`\${basePath}/components/headless-logic/headless-component.js\`);
                window.HeadlessComponentModule = HeadlessComponentModule;
                log('HeadlessComponent loaded: ' + (HeadlessComponentModule ? 'OK' : 'Failed'));


                log('Attempting to load HeadlessButton...');
                const { HeadlessButton } = await import(\`\${basePath}/components/headless-logic/headless-button.js\`);
                window.headlessButtonInstance = new HeadlessButton(); // For test checks
                log('HeadlessButton loaded: ' + (HeadlessButton ? 'OK' : 'Failed'));

                log('Attempting to load useHeadlessComponent...');
                const { useHeadlessComponent } = await import(\`\${basePath}/hooks/use-headless-component.js\`);
                window.useHeadlessComponentModule = useHeadlessComponent; // For test checks
                log('useHeadlessComponent loaded: ' + (useHeadlessComponent ? 'OK' : 'Failed'));

                const App = () => {
                    const { component, componentState, undo, redo, history } = useHeadlessComponent(HeadlessButton);

                    React.useEffect(() => {
                        const unsubscribe = component.subscribe('clicked', () => {
                            log('Button clicked!');
                        });
                        return unsubscribe;
                    }, [component]);
                    
                    // Expose for Playwright tests
                    window.headlessComponentInstance = component;


                    return React.createElement('div', null,
                        React.createElement('button', {
                            onClick: () => component.click(),
                            disabled: componentState.isDisabled || componentState.isLoading,
                            style: { 
                                backgroundColor: componentState.isPressed ? 'darkblue' : (componentState.isHovered ? 'blue' : 'dodgerblue'),
                                padding: '10px 20px',
                                color: 'white',
                                border: 'none',
                                borderRadius: '5px',
                                cursor: (componentState.isDisabled || componentState.isLoading) ? 'not-allowed' : 'pointer',
                                opacity: (componentState.isDisabled || componentState.isLoading) ? 0.6 : 1,
                            },
                            onMouseEnter: () => component.hover(true),
                            onMouseLeave: () => component.hover(false),
                            onMouseDown: () => component.press(true),
                            onMouseUp: () => component.press(false),
                            onFocus: () => component.focus(true),
                            onBlur: () => component.focus(false),
                        }, 'My Styled Button'),
                        React.createElement('div', { style: { marginTop: '10px'} },
                            React.createElement('button', { onClick: () => component.setState({ isDisabled: !componentState.isDisabled }) }, 'Toggle Disable'),
                            React.createElement('button', { onClick: () => component.setState({ isLoading: !componentState.isLoading }) }, 'Toggle Loading'),
                            React.createElement('button', { onClick: undo, disabled: !history.canUndo }, 'Undo'),
                            React.createElement('button', { onClick: redo, disabled: !history.canRedo }, 'Redo')
                        ),
                        React.createElement('pre', { style: { fontSize: '0.8em', marginTop: '10px', backgroundColor: '#eee', padding: '10px' } }, JSON.stringify(componentState, null, 2))
                    );
                };

                const root = window.ReactDOM.createRoot(document.getElementById('root'));
                root.render(React.createElement(App));
                log('React app rendered.');
                window.headlessModulesLoaded = true; // For Playwright tests

            } catch (error) {
                log('ERROR in main(): ' + error);
                if (error.stack) {
                    log('Stack: ' + error.stack);
                }
                console.error("Detailed error:", error);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', main);
        } else {
            main();
        }

    </script>
</body>
</html>
