<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeadlessButton ESM Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        button {
            padding: 10px 15px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer;
            background-color: #007bff; color: white; transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #e0e0e0; color: #999; cursor: not-allowed; }
        button[data-pressed="true"] { background-color: #004085; }
        #state-display { margin-top: 15px; padding: 10px; background-color: #eee; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .controls label { display: block; margin: 5px 0; }
        .troubleshooting { margin-top: 20px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 4px; color: #856404;}
    </style>
</head>
<body>
    <div class="container">
        <h1>HeadlessButton ESM Example (from GitHub via jsDelivr)</h1>
        <p>This example demonstrates using the <code>HeadlessButton</code> directly from your GitHub repository via jsDelivr CDN.</p>
        
        <div class="troubleshooting">
            <p><strong>Troubleshooting 404s:</strong></p>
            <ol>
                <li>Ensure the <code>dist</code> folder (created by <code>npm run build:logic</code>) is committed and pushed to the <code>master</code> branch of your <a href="https://github.com/lambdaX/headless-primitives-kit" target="_blank">lambdaX/headless-primitives-kit</a> repository. The "Build and Deploy Headless Logic" GitHub Action should handle this.</li>
                <li>Verify that the "Deploy to GitHub Pages" GitHub Action completed successfully and deployed to the <code>gh-pages</code> branch.</li>
                <li>Check your repository's GitHub Pages settings to ensure it's serving from the <code>gh-pages</code> branch.</li>
                <li>There might be a short delay for GitHub Pages to update after a deployment.</li>
            </ol>
        </div>

        <div id="react-root">Button will load here...</div>
        <div class="controls" style="margin-top: 20px;">
            <label><input type="checkbox" id="toggle-disabled" /> Disabled</label>
            <label><input type="checkbox" id="toggle-loading" /> Loading</label>
            <label><input type="checkbox" id="toggle-error" /> Error</label>
            <button id="undo-btn">Undo</button>
            <button id="redo-btn">Redo</button>
        </div>
        <div id="state-display">Current state will appear here.</div>
    </div>

    <script type="module">
        // Dynamically import React and ReactDOM from esm.sh for browser ESM compatibility
        const React = await import('https://esm.sh/react@18.3.1');
        const ReactDOM = await import('https://esm.sh/react-dom@18.3.1/client');

        // Import your headless components and related classes
        // These URLs point to files in the 'dist' directory on the 'master' branch of your repo.
        const { HeadlessButton } = await import('https://cdn.jsdelivr.net/gh/lambdaX/headless-primitives-kit@master/dist/headless-button.js');
        // For a real application, you'd likely import other base classes/utilities if they are not re-exported by headless-button.js
        // e.g., import { HeadlessComponent } from 'https://cdn.jsdelivr.net/gh/lambdaX/headless-primitives-kit@master/dist/headless-component.js';
        // For this example, we assume HeadlessButton is sufficiently self-contained or its internal imports resolve correctly via jsDelivr.

        const { useState, useEffect, useMemo, useCallback } = React;

        function MyStyledButton() {
            const buttonLogic = useMemo(() => {
                try {
                    return new HeadlessButton();
                } catch (e) {
                    console.error("Error instantiating HeadlessButton:", e);
                    document.getElementById('react-root').textContent = 'Error loading HeadlessButton. Check console and CDN links.';
                    return null;
                }
            }, []);

            if (!buttonLogic) return null; // Stop rendering if buttonLogic failed to instantiate

            const [componentState, setComponentState] = useState(buttonLogic.getState());
            const [cssState, setCssState] = useState(buttonLogic.getCSSState());
            const [history, setHistory] = useState(buttonLogic.getHistory());

            useEffect(() => {
                const onStateChanged = (event, newState) => setComponentState(newState);
                const onCssChanged = (event, newCss) => setCssState(newCss);
                const onHistoryChanged = (event, newHistory) => setHistory(newHistory);

                const unsubState = buttonLogic.subscribe('stateChanged', onStateChanged);
                const unsubCss = buttonLogic.subscribe('cssStateChanged', onCssChanged);
                const unsubTransition = buttonLogic.subscribe('stateTransition', () => {
                    setComponentState(buttonLogic.getState());
                    setCssState(buttonLogic.getCSSState());
                });
                const unsubHistory = buttonLogic.subscribe('historyChanged', onHistoryChanged);
                
                // Initial sync
                setComponentState(buttonLogic.getState());
                setCssState(buttonLogic.getCSSState());
                setHistory(buttonLogic.getHistory());

                return () => {
                    unsubState(); unsubCss(); unsubTransition(); unsubHistory();
                };
            }, [buttonLogic]);

            // UI Controls
            useEffect(() => {
                const disabledToggle = document.getElementById('toggle-disabled');
                const loadingToggle = document.getElementById('toggle-loading');
                const errorToggle = document.getElementById('toggle-error');
                const undoBtn = document.getElementById('undo-btn');
                const redoBtn = document.getElementById('redo-btn');

                const handleDisabledChange = (e) => buttonLogic.setDisabled(e.target.checked);
                const handleLoadingChange = (e) => buttonLogic.setLoading(e.target.checked);
                const handleErrorChange = (e) => buttonLogic.setError(e.target.checked ? "Sample Error" : null);
                const handleUndo = () => buttonLogic.undo();
                const handleRedo = () => buttonLogic.redo();

                disabledToggle.addEventListener('change', handleDisabledChange);
                loadingToggle.addEventListener('change', handleLoadingChange);
                errorToggle.addEventListener('change', handleErrorChange);
                undoBtn.addEventListener('click', handleUndo);
                redoBtn.addEventListener('click', handleRedo);

                // Set initial checkbox states from component
                disabledToggle.checked = !!buttonLogic.getState().isDisabled;
                loadingToggle.checked = !!buttonLogic.getState().isLoading;
                errorToggle.checked = !!buttonLogic.getState().error;


                return () => {
                    disabledToggle.removeEventListener('change', handleDisabledChange);
                    loadingToggle.removeEventListener('change', handleLoadingChange);
                    errorToggle.removeEventListener('change', handleErrorChange);
                    undoBtn.removeEventListener('click', handleUndo);
                    redoBtn.removeEventListener('click', handleRedo);
                };
            }, [buttonLogic]);
            
            // Update state display
            useEffect(() => {
                document.getElementById('state-display').textContent = JSON.stringify({ state: componentState, css: cssState, history }, null, 2);
            }, [componentState, cssState, history]);


            return React.createElement('button', {
                type: 'button',
                onClick: (e) => buttonLogic.click(e),
                onMouseEnter: (e) => buttonLogic.hover(true, e),
                onMouseLeave: (e) => buttonLogic.hover(false, e),
                onFocus: (e) => buttonLogic.focus(true, e),
                onBlur: (e) => buttonLogic.focus(false, e),
                onKeyDown: (e) => buttonLogic.keydown(e),
                onMouseDown: () => buttonLogic.press(true),
                onMouseUp: () => buttonLogic.press(false),
                disabled: componentState.isDisabled || componentState.isLoading,
                'aria-disabled': componentState.isDisabled || componentState.isLoading,
                className: cssState.classes.join(' ') + (componentState.isPressed ? ' pressed' : ''), // Added specific pressed class for demo style
                ...cssState.dataAttributes, // Apply data attributes for styling
            }, componentState.isLoading ? 'Loading...' : (componentState.error ? 'Error!' : 'Click Me (ESM)'));
        }
        
        try {
            const root = ReactDOM.createRoot(document.getElementById('react-root'));
            root.render(React.createElement(MyStyledButton));
        } catch (error) {
            console.error("Error rendering React component:", error);
            document.getElementById('react-root').textContent = 'Failed to render React component. See console for details.';
        }
    </script>
</body>
</html>
