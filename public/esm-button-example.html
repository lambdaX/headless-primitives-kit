<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeadlessButton ESM E2E Test</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        #root { margin-top: 20px; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button {
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #e0e0e0;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #d0d0d0; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        button.focused { outline: 2px solid blue; }
        button.pressed { background-color: #c0c0c0; }
        .info { padding: 10px; border: 1px solid #ddd; margin-bottom:10px; border-radius: 4px; }
        .state-display { margin-top: 10px; padding: 10px; background-color: #eee; border-radius: 4px; font-family: monospace; white-space: pre; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>HeadlessButton ESM E2E Test</h1>
    <div id="info-message" class="info">Loading...</div>
    <div id="root"></div>

    <script type="module">
        const infoEl = document.getElementById('info-message');
        function logInfo(message, isError = false) {
            console.log(message);
            infoEl.textContent = message;
            if (isError) infoEl.classList.add('error');
            else infoEl.classList.remove('error');
        }

        async function main() {
            try {
                logInfo('Determining base path...');
                const params = new URLSearchParams(window.location.search);
                const useLocal = params.get('local') === 'true';
                const repoOwner = 'lambdaX';
                const repoName = 'headless-primitives-kit';
                const branch = 'master'; // Or your default branch / a specific tag/commit

                // If serving locally for E2E, dist is at the root relative to where 'serve' serves from.
                // public/esm-button-example.html is served at /public/esm-button-example.html
                // dist/ is at /dist/
                // So relative path from public/ to dist/ is '../dist/'
                const basePath = useLocal
                    ? '../dist'
                    : `https://cdn.jsdelivr.net/gh/${repoOwner}/${repoName}@${branch}/dist`;

                logInfo(`Using base path: ${basePath}`);

                logInfo('Attempting to load React...');
                const React = await import('https://esm.sh/react@18.3.1');
                logInfo('React loaded.');
                window.React = React.default; // Make it globally available if needed for other scripts or JSX transform

                logInfo('Attempting to load ReactDOM...');
                const ReactDOM = await import('https://esm.sh/react-dom@18.3.1/client');
                logInfo('ReactDOM loaded.');

                // Construct full paths to the .js files
                const headlessButtonModulePath = `${basePath}/components/headless-logic/headless-button.js`;
                const useHeadlessComponentModulePath = `${basePath}/hooks/use-headless-component.js`;

                logInfo(`Attempting to load HeadlessButton from ${headlessButtonModulePath}...`);
                const { HeadlessButton } = await import(headlessButtonModulePath);
                logInfo('HeadlessButton loaded.');

                logInfo(`Attempting to load useHeadlessComponent from ${useHeadlessComponentModulePath}...`);
                const { useHeadlessComponent } = await import(useHeadlessComponentModulePath);
                logInfo('useHeadlessComponent loaded.');

                const App = () => {
                    const {
                        component,
                        componentState,
                        cssState,
                        history,
                        undo,
                        redo
                    } = useHeadlessComponent(HeadlessButton);

                    React.useEffect(() => {
                        const handleClick = () => alert('Button clicked via subscription!');
                        const unsubscribe = component.subscribe('clicked', handleClick);
                        return () => unsubscribe();
                    }, [component]);
                    
                    const buttonClasses = [
                        componentState.isFocused ? 'focused' : '',
                        componentState.isPressed ? 'pressed' : '',
                    ].filter(Boolean).join(' ');

                    return React.createElement('div', null,
                        React.createElement('button', {
                                type: 'button',
                                onClick: (e) => component.click(e),
                                onMouseEnter: (e) => component.hover(true, e),
                                onMouseLeave: (e) => component.hover(false, e),
                                onFocus: (e) => component.focus(true, e),
                                onBlur: (e) => component.focus(false, e),
                                onKeyDown: (e) => component.keydown(e.nativeEvent),
                                onMouseDown: () => component.press(true),
                                onMouseUp: () => component.press(false),
                                disabled: componentState.isDisabled || componentState.isLoading,
                                className: buttonClasses,
                                ...cssState.dataAttributes
                            },
                            componentState.isLoading ? 'Loading...' : 'Click Me (ESM)'
                        ),
                        React.createElement('div', { className: 'state-display' },
                            React.createElement('h3', null, 'Component State:'),
                            React.createElement('pre', null, JSON.stringify(componentState, null, 2)),
                            React.createElement('h3', null, 'CSS State:'),
                            React.createElement('pre', null, JSON.stringify(cssState, null, 2)),
                            React.createElement('h3', null, 'History:'),
                            React.createElement('pre', null, JSON.stringify(history, null, 2))
                        ),
                        React.createElement('div', { style: { marginTop: '10px' } },
                            React.createElement('button', { onClick: undo, disabled: !history.canUndo, style: {marginRight: '5px'} }, 'Undo'),
                            React.createElement('button', { onClick: redo, disabled: !history.canRedo }, 'Redo')
                        ),
                        React.createElement('div', { style: { marginTop: '20px'} },
                            React.createElement('p', null, 'Controls:'),
                            React.createElement('button', { onClick: () => component.setDisabled(!componentState.isDisabled), style: {marginRight: '5px'} }, 'Toggle Disabled'),
                            React.createElement('button', { onClick: () => component.setLoading(!componentState.isLoading) }, 'Toggle Loading')
                        )
                    );
                };

                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(React.createElement(App));
                logInfo('Application rendered successfully!');

            } catch (error) {
                logInfo(`ERROR in main(): ${error.message}`, true);
                console.error("Detailed error:", error);
            }
        }

        main();
    </script>
</body>
</html>