<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeadlessButton ESM Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; background-color: #f0f7ff; }
        #button-container button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        #button-container button.idle { background-color: #007bff; color: white; border-color: #007bff; }
        #button-container button.hovered { background-color: #0056b3; color: white; border-color: #0056b3; }
        #button-container button.focused { border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        #button-container button.pressed { background-color: #004085; color: white; transform: scale(0.98); }
        #button-container button.disabled { background-color: #cccccc; color: #666666; cursor: not-allowed; }
        #button-container button.loading { background-color: #a6d7ff; color: #004085; cursor: wait; }
        #button-container button.error { background-color: #ffdddd; color: #d8000c; border-color: #d8000c; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .controls button { padding: 8px 15px; border-radius: 4px; border: 1px solid #ccc; background-color: #fff; cursor: pointer; }
        .controls button:disabled { background-color: #eee; cursor: not-allowed; }
        #log-output { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #fff; width: 100%; max-width: 600px; height: 150px; overflow-y: auto; font-size: 0.9em; }
        .info { font-size: 0.8em; color: #555; text-align: center; }
        .error-message { color: red; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>HeadlessButton Vanilla JS (ESM) Example</h1>
    <p class="info">This example demonstrates using the HeadlessButton directly in HTML/JS via ESM imports from a CDN.</p>
    <p class="info">Check your browser's developer console for detailed loading logs and potential errors.</p>

    <div class="controls">
        <button id="toggle-disable">Toggle Disable</button>
        <button id="toggle-loading">Toggle Loading</button>
        <button id="toggle-error">Toggle Error</button>
        <button id="undo-btn">Undo</button>
        <button id="redo-btn">Redo</button>
    </div>

    <div id="button-container">
        <p>Loading button...</p>
    </div>

    <div id="log-output"><strong>Log:</strong><br></div>
    <div id="error-display" class="error-message"></div>

    <script type="module">
        const logOutput = document.getElementById('log-output');
        const errorDisplay = document.getElementById('error-display');

        function log(message) {
            console.log(message);
            const p = document.createElement('p');
            p.textContent = message;
            logOutput.appendChild(p);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        async function main() {
            try {
                log('Attempting to load React...');
                const ReactModule = await import('https://esm.sh/react@18.3.1');
                window.React = ReactModule.default || ReactModule;
                if (!window.React || !window.React.createElement) throw new Error("React not loaded correctly.");
                log('React loaded.');

                log('Attempting to load ReactDOM...');
                const ReactDOMModule = await import('https://esm.sh/react-dom@18.3.1/client');
                window.ReactDOM = ReactDOMModule.default || ReactDOMModule;
                if (!window.ReactDOM || !window.ReactDOM.createRoot) throw new Error("ReactDOM not loaded correctly.");
                log('ReactDOM loaded.');

                const { useEffect, useState, useMemo } = window.React;

                const basePath = 'https://cdn.jsdelivr.net/gh/lambdaX/headless-primitives-kit@master/dist';
                log(`Base path for headless-primitives-kit: ${basePath}`);

                log('Attempting to load HeadlessComponent base...');
                // HeadlessComponent and dependencies like Command, EventEmitter, ComponentState are imported by HeadlessButton itself
                await import(`${basePath}/components/headless-logic/headless-component.js`);
                log('HeadlessComponent base and its dependencies likely loaded by now (if paths are correct in its source).');

                log('Attempting to load useHeadlessComponent hook...');
                const useHeadlessComponentModule = await import(`${basePath}/hooks/use-headless-component.js`);
                const { useHeadlessComponent } = useHeadlessComponentModule;
                if (!useHeadlessComponent) throw new Error("useHeadlessComponent not loaded.");
                log('useHeadlessComponent hook loaded.');

                log('Attempting to load HeadlessButton...');
                const HeadlessButtonModule = await import(`${basePath}/components/headless-logic/headless-button.js`);
                const { HeadlessButton } = HeadlessButtonModule;
                if (!HeadlessButton) throw new Error("HeadlessButton not loaded.");
                log('HeadlessButton loaded.');

                function MyStyledButton({ initialText = "Click Me" }) {
                    const { component, componentState, cssState, history, undo, redo } = useHeadlessComponent(HeadlessButton);

                    window.headlessButtonInstance = component; // Expose for external controls
                    window.undoLastAction = undo;
                    window.redoLastAction = redo;

                    useEffect(() => {
                        const handleStateChange = () => {
                           log(`Button state: ${JSON.stringify(component.getState())}, CSS: ${JSON.stringify(component.getCSSState().classes)}`);
                           // Update history display or other UI elements if needed
                        };
                        component.subscribe('stateChanged', handleStateChange);
                        component.subscribe('cssStateChanged', handleStateChange); // For visual updates
                        component.subscribe('historyChanged', handleStateChange);
                        return () => {
                            component.unsubscribe('stateChanged', handleStateChange);
                            component.unsubscribe('cssStateChanged', handleStateChange);
                            component.unsubscribe('historyChanged', handleStateChange);
                        };
                    }, [component]);

                    let currentVisualState = 'idle';
                    if (componentState.isDisabled) currentVisualState = 'disabled';
                    else if (componentState.isLoading) currentVisualState = 'loading';
                    else if (componentState.error) currentVisualState = 'error';
                    else if (componentState.isPressed) currentVisualState = 'pressed';
                    else if (componentState.isFocused) currentVisualState = 'focused';
                    else if (componentState.isHovered) currentVisualState = 'hovered';

                    const buttonText = componentState.isLoading ? 'Processing...' : 
                                       componentState.error ? 'Error!' : initialText;

                    return React.createElement('button', {
                        type: 'button',
                        className: `${cssState.classes.join(' ')} ${currentVisualState}`,
                        ...cssState.dataAttributes,
                        disabled: componentState.isDisabled || componentState.isLoading,
                        onClick: (e) => component.click(e),
                        onMouseEnter: (e) => component.hover(true, e),
                        onMouseLeave: (e) => component.hover(false, e),
                        onFocus: (e) => component.focus(true, e),
                        onBlur: (e) => component.focus(false, e),
                        onKeyDown: (e) => component.keydown(e),
                        onMouseDown: () => component.press(true),
                        onMouseUp: () => component.press(false)
                    }, buttonText);
                }

                const container = document.getElementById('button-container');
                container.innerHTML = ''; // Clear "Loading button..."
                const root = window.ReactDOM.createRoot(container);
                root.render(React.createElement(MyStyledButton, { initialText: "ESM Button" }));
                log('React component rendered.');

                // Setup external controls
                document.getElementById('toggle-disable').addEventListener('click', () => {
                    if (window.headlessButtonInstance) {
                        const current = window.headlessButtonInstance.getState();
                        window.headlessButtonInstance.setDisabled(!current.isDisabled);
                    }
                });
                document.getElementById('toggle-loading').addEventListener('click', () => {
                    if (window.headlessButtonInstance) {
                        const current = window.headlessButtonInstance.getState();
                        window.headlessButtonInstance.setLoading(!current.isLoading);
                    }
                });
                document.getElementById('toggle-error').addEventListener('click', () => {
                    if (window.headlessButtonInstance) {
                        const current = window.headlessButtonInstance.getState();
                        window.headlessButtonInstance.setError(current.error ? null : 'Sample Error!');
                    }
                });
                document.getElementById('undo-btn').addEventListener('click', () => window.undoLastAction && window.undoLastAction());
                document.getElementById('redo-btn').addEventListener('click', () => window.redoLastAction && window.redoLastAction());

            } catch (error) {
                log(`ERROR in main(): ${error.message}`);
                errorDisplay.textContent = `Failed to load or initialize component. Check console. Error: ${error.message}`;
                console.error("Detailed error:", error);
            }
        }

        main();
    </script>
</body>
</html>
