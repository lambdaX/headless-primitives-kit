<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeadlessButton ESM Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f7fc; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s, opacity 0.2s;
            margin-right: 10px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; border-color: #ccc; color: #666; cursor: not-allowed; opacity: 0.7; }
        button.pressed { background-color: #004085; transform: scale(0.98); }
        .controls { margin-top: 20px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .controls label { margin-right: 5px; }
        .state-display { margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 5px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .icon { display: inline-block; margin-right: 5px; }
        .error-state { border: 1px solid red !important; background-color: #ffe0e0 !important; color: red !important; }
        .loading-state::after { content: '...'; display: inline-block; animation: loading-dots 1s infinite steps(3, end); }
        @keyframes loading-dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>HeadlessButton ESM Test</h1>
        <p>This example demonstrates using the <code>HeadlessButton</code> primitive directly in the browser via ES module imports from a CDN.</p>
        
        <div id="react-root">Button will load here...</div>

        <div class="controls">
            <button id="toggle-disabled">Toggle Disabled</button>
            <button id="toggle-loading">Toggle Loading</button>
            <button id="toggle-error">Toggle Error</button>
            <button id="undo">Undo</button>
            <button id="redo">Redo</button>
        </div>
        <div class="state-display" id="state-json">
            Current State: Loading...
        </div>
    </div>

    <script type="module">
        // Import React and ReactDOM from a CDN like esm.sh
        const { default: React, useState, useEffect, useMemo } = await import('https://esm.sh/react@18.2.0');
        const { default: ReactDOM } = await import('https://esm.sh/react-dom@18.2.0/client');

        // Imports for your headless library from jsDelivr (points to GitHub)
        // Ensure your package name and path are correct. This assumes the compiled files are in a 'dist' folder.
        const CDN_BASE = 'https://cdn.jsdelivr.net/gh/lambdaX/headless-primitives-kit@main/dist/';

        const { HeadlessButton } = await import(CDN_BASE + 'headless-button.js');
        // HeadlessButton internally imports HeadlessComponent, EventEmitter, Command, ComponentState, InteractionStrategy etc.
        // So, we don't strictly need to import them all here if HeadlessButton's module correctly exports/imports them relatively.
        // However, to be explicit and ensure the example script has access to create custom strategies or commands if needed,
        // we might import them. For this example, let's assume HeadlessButton is self-contained with its direct needs.
        // If direct access to Command, CommandInvoker etc. is needed by *this script*, then import them:
        const { Command, CommandInvoker } = await import(CDN_BASE + 'command.js');


        function MyInteractiveButton({ headlessButton }) {
            const [componentState, setComponentState] = useState(headlessButton.getState());
            const [cssState, setCssState] = useState(headlessButton.getCSSState());
            const [history, setHistory] = useState(headlessButton.getHistory());

            useEffect(() => {
                const onStateChanged = (event, newState) => {
                    setComponentState(newState);
                    document.getElementById('state-json').textContent = JSON.stringify({ data: newState, css: headlessButton.getCSSState(), history: headlessButton.getHistory() }, null, 2);
                };
                const onCssStateChanged = (event, newCssState) => setCssState(newCssState);
                const onHistoryChanged = (event, newHistory) => setHistory(newHistory);
                
                const unsubState = headlessButton.subscribe('stateChanged', onStateChanged);
                const unsubCss = headlessButton.subscribe('cssStateChanged', onCssStateChanged);
                const unsubTransition = headlessButton.subscribe('stateTransition', () => {
                    setComponentState(headlessButton.getState());
                    setCssState(headlessButton.getCSSState());
                });
                const unsubHistory = headlessButton.subscribe('historyChanged', onHistoryChanged);

                // Initial sync
                onStateChanged(null, headlessButton.getState());

                return () => {
                    unsubState(); unsubCss(); unsubTransition(); unsubHistory();
                };
            }, [headlessButton]);

            let buttonText = "Click Me";
            let icon = "";
            if (componentState.isLoading) {
                buttonText = "Loading...";
                icon = '<span class="icon loading-state"></span>';
            } else if (componentState.error) {
                buttonText = "Error!";
                icon = '<span class="icon">‚ö†Ô∏è</span>';
            } else if (componentState.isDisabled) {
                buttonText = "Disabled";
                icon = '<span class="icon">üö´</span>';
            }
            
            const combinedClasses = [
                ...(cssState.classes || []),
                componentState.isPressed ? 'pressed' : '',
                componentState.error ? 'error-state' : ''
            ].filter(Boolean).join(' ');

            return React.createElement('button', {
                type: 'button',
                onClick: (e) => headlessButton.click(e),
                onMouseEnter: (e) => headlessButton.hover(true, e),
                onMouseLeave: (e) => headlessButton.hover(false, e),
                onFocus: (e) => headlessButton.focus(true, e),
                onBlur: (e) => headlessButton.focus(false, e),
                onKeyDown: (e) => headlessButton.keydown(e),
                onMouseDown: () => headlessButton.press(true),
                onMouseUp: () => headlessButton.press(false),
                disabled: componentState.isDisabled || componentState.isLoading,
                className: combinedClasses,
                ...cssState.dataAttributes,
                dangerouslySetInnerHTML: { __html: icon + buttonText }
            });
        }

        const App = () => {
            // Instantiate the headless button logic
            const buttonLogic = useMemo(() => new HeadlessButton(), []);
            
            // Setup controls
            useEffect(() => {
                document.getElementById('toggle-disabled').onclick = () => buttonLogic.setDisabled(!buttonLogic.getState().isDisabled);
                document.getElementById('toggle-loading').onclick = () => buttonLogic.setLoading(!buttonLogic.getState().isLoading);
                document.getElementById('toggle-error').onclick = () => buttonLogic.setError(buttonLogic.getState().error ? null : 'An error occurred!');
                document.getElementById('undo').onclick = () => buttonLogic.undo();
                document.getElementById('redo').onclick = () => buttonLogic.redo();
                
                // Initial state display
                 document.getElementById('state-json').textContent = JSON.stringify({ 
                    data: buttonLogic.getState(), 
                    css: buttonLogic.getCSSState(),
                    history: buttonLogic.getHistory()
                }, null, 2);

            }, [buttonLogic]);

            return React.createElement(MyInteractiveButton, { headlessButton: buttonLogic });
        };

        // Render the React application
        const root = ReactDOM.createRoot(document.getElementById('react-root'));
        root.render(React.createElement(App));

    </script>
</body>
</html>
