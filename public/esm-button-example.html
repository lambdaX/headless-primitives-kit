<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeadlessButton ESM Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; color: #333; }
        #root { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button {
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #e0e0e0; color: #999; cursor: not-allowed; }
        button.pressed { background-color: #004085; }
        .controls, .state-display { margin-top: 15px; padding: 10px; border: 1px solid #eee; border-radius: 5px; }
        .state-display pre { background-color: #282c34; color: #abb2bf; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .error { color: red; font-weight: bold; }
        .loading { opacity: 0.7; }
        .error-state { border: 2px solid red !important; }
        h1, h2 { color: #007bff; }
    </style>
</head>
<body>
    <h1>HeadlessButton ESM Example</h1>
    <p>This example demonstrates using the <code>HeadlessButton</code> directly from a CDN using ES Modules.</p>
    <p>
        <strong>Important:</strong> This example fetches the library files from jsDelivr, which serves them from the <code>dist</code> directory of the
        <code>master</code> branch of the <a href="https://github.com/lambdaX/headless-primitives-kit" target="_blank" rel="noopener noreferrer">lambdaX/headless-primitives-kit</a> repository.
        Ensure the <code>dist</code> folder is correctly built and pushed to the <code>master</code> branch by the CI workflow.
    </p>

    <div id="root">Button will be rendered here if React and the component load correctly.</div>

    <script type="module">
        // Import React and ReactDOM from a CDN
        const reactUrl = 'https://esm.sh/react@18.3.1';
        const reactDomUrl = 'https://esm.sh/react-dom@18.3.1/client';

        // Base URL for your library on jsDelivr
        const libBaseUrl = 'https://cdn.jsdelivr.net/gh/lambdaX/headless-primitives-kit@master/dist/';

        try {
            const { default: React, useState, useEffect, useMemo } = await import(reactUrl);
            const { createRoot } = await import(reactDomUrl);

            // Import Headless Components and supporting classes/types from jsDelivr
            const { HeadlessButton } = await import(libBaseUrl + 'headless-button.js');
            const { EventEmitter } = await import(libBaseUrl + 'event-emitter.js');
            const { Command, CommandInvoker } = await import(libBaseUrl + 'command.js');
            const { ComponentState, IdleState, HoveredState, FocusedState, PressedState, DisabledState, LoadingState, ErrorState } = await import(libBaseUrl + 'component-states.js');
            const { InteractionStrategy, ButtonClickStrategy, HoverStrategy, FocusStrategy, KeyboardStrategy } = await import(libBaseUrl + 'interaction-strategies.js');
            const { HeadlessComponent } = await import(libBaseUrl + 'headless-component.js');


            function App() {
                const [buttonInstance, setButtonInstance] = useState(null);
                const [buttonState, setButtonState] = useState(null);
                const [cssState, setCssState] = useState({ classes: [], dataAttributes: {} });
                const [historyState, setHistoryState] = useState(null);
                const [error, setError] = useState(null);

                useEffect(() => {
                    try {
                        const btn = new HeadlessButton();
                        setButtonInstance(btn);
                        setButtonState(btn.getState());
                        setCssState(btn.getCSSState());
                        setHistoryState(btn.getHistory());

                        const onStateChange = (_, newState) => setButtonState(newState);
                        const onCssChange = (_, newCss) => setCssState(newCss);
                        const onHistoryChange = (_, newHist) => setHistoryState(newHist);
                        const onTransition = () => {
                            setButtonState(btn.getState());
                            setCssState(btn.getCSSState());
                        };

                        btn.subscribe('stateChanged', onStateChange);
                        btn.subscribe('cssStateChanged', onCssChange);
                        btn.subscribe('historyChanged', onHistoryChange);
                        btn.subscribe('stateTransition', onTransition);
                        btn.subscribe('clicked', () => console.log('Button clicked via HeadlessButton!'));

                        return () => {
                            btn.unsubscribe('stateChanged', onStateChange);
                            btn.unsubscribe('cssStateChanged', onCssChange);
                            btn.unsubscribe('historyChanged', onHistoryChange);
                            btn.unsubscribe('stateTransition', onTransition);
                        };
                    } catch (e) {
                        console.error("Error initializing HeadlessButton:", e);
                        setError("Failed to initialize HeadlessButton: " + e.message);
                    }
                }, []);

                if (error) {
                    return <p className="error">Error: {error}</p>;
                }

                if (!buttonInstance || !buttonState) {
                    return <p>Loading button component...</p>;
                }

                const currentCssClasses = cssState.classes || [];
                const currentDataAttributes = cssState.dataAttributes || {};

                return (
                    React.createElement('div', null,
                        React.createElement('button', {
                            type: 'button',
                            onClick: (e) => buttonInstance.click(e),
                            onMouseEnter: (e) => buttonInstance.hover(true, e),
                            onMouseLeave: (e) => buttonInstance.hover(false, e),
                            onFocus: (e) => buttonInstance.focus(true, e),
                            onBlur: (e) => buttonInstance.focus(false, e),
                            onKeyDown: (e) => buttonInstance.keydown(e),
                            onMouseDown: () => buttonInstance.press(true),
                            onMouseUp: () => buttonInstance.press(false),
                            disabled: buttonState.isDisabled || buttonState.isLoading,
                            className: [
                                ...currentCssClasses,
                                buttonState.isPressed ? 'pressed' : '',
                                buttonState.error ? 'error-state' : '',
                                buttonState.isLoading ? 'loading' : ''
                            ].join(' ').trim(),
                            ...currentDataAttributes
                        }, buttonState.isLoading ? 'Loading...' : buttonState.error ? 'Error!' : 'Click Me (Headless)'),
                        React.createElement('div', { className: 'controls' },
                            React.createElement('h2', null, 'Controls'),
                            React.createElement('button', { onClick: () => buttonInstance.setDisabled(!buttonState.isDisabled) }, 'Toggle Disabled'),
                            React.createElement('button', { onClick: () => buttonInstance.setLoading(!buttonState.isLoading) }, 'Toggle Loading'),
                            React.createElement('button', { onClick: () => buttonInstance.setError(buttonState.error ? null : 'Sample Error!') }, 'Toggle Error'),
                            React.createElement('button', { onClick: () => buttonInstance.undo(), disabled: historyState && !historyState.canUndo }, 'Undo'),
                            React.createElement('button', { onClick: () => buttonInstance.redo(), disabled: historyState && !historyState.canRedo }, 'Redo')
                        ),
                        React.createElement('div', { className: 'state-display' },
                            React.createElement('h2', null, 'Current State'),
                            React.createElement('pre', null, JSON.stringify({ dataState: buttonState, cssState, historyState }, null, 2))
                        )
                    )
                );
            }

            const container = document.getElementById('root');
            if (container) {
                const root = createRoot(container);
                root.render(React.createElement(App));
            } else {
                console.error("Root container not found");
                document.body.innerHTML = '<p class="error">Error: Root container #root not found in HTML.</p>';
            }

        } catch (err) {
            console.error('Failed to load modules or render React component:', err);
            const rootDiv = document.getElementById('root');
            if (rootDiv) {
                rootDiv.innerHTML = '<p class="error" style="color: red; font-weight: bold;">Failed to load necessary scripts. Check console for details. Error: ' + err.message + '</p>';
            } else {
                 document.body.innerHTML = '<p class="error" style="color: red; font-weight: bold;">Critical loading error. Check console. Error: ' + err.message + '</p>';
            }
        }
    </script>
</body>
</html>
