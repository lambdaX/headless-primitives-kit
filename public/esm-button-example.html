<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeadlessButton ESM Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        #app { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; min-width: 200px; text-align: center; }
        button {
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; border-color: #ccc; cursor: not-allowed; }
        .log-container { margin-top: 20px; width: 100%; max-width: 600px; border: 1px solid #eee; padding: 10px; height: 150px; overflow-y: auto; font-size: 0.9em; background: #f9f9f9; }
        .log-container p { margin: 2px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>HeadlessButton ESM Example</h1>
    <p>This example demonstrates using the <code>HeadlessButton</code> and <code>useHeadlessComponent</code> hook directly in a browser via ESM modules loaded from a CDN (jsDelivr).</p>
    <p>It assumes your library has been built and the <code>dist</code> folder is available on the <code>master</code> branch of your GitHub repository.</p>

    <div id="log" class="log-container"></div>
    <div id="app">
        <p>Loading component...</p>
    </div>

    <script type="module">
        const logElement = document.getElementById('log');
        function log(message, type = 'info') {
            console.log(message);
            const p = document.createElement('p');
            p.textContent = message;
            if (type === 'error') p.classList.add('error');
            logElement.appendChild(p);
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function main() {
            try {
                log('Attempting to load React...');
                const ReactModule = await import('https://esm.sh/react@18.3.1');
                window.React = ReactModule.default || ReactModule;
                if (!window.React || !window.React.createElement) throw new Error("React not loaded correctly.");
                log('React loaded.');

                log('Attempting to load ReactDOM...');
                const ReactDOMModule = await import('https://esm.sh/react-dom@18.3.1/client');
                window.ReactDOM = ReactDOMModule.default || ReactDOMModule;
                if (!window.ReactDOM || !window.ReactDOM.createRoot) throw new Error("ReactDOM not loaded correctly.");
                log('ReactDOM loaded.');

                const basePath = 'https://cdn.jsdelivr.net/gh/lambdaX/headless-primitives-kit@master/dist';
                log(`Base path for headless-primitives-kit: ${basePath}`);

                log('Attempting to load HeadlessComponent...');
                const { HeadlessComponent } = await import(`${basePath}/components/headless-logic/headless-component.js`);
                log('HeadlessComponent loaded.');
                
                log('Attempting to load HeadlessButton...');
                const { HeadlessButton } = await import(`${basePath}/components/headless-logic/headless-button.js`);
                if (!HeadlessButton) throw new Error("HeadlessButton not loaded.");
                log('HeadlessButton loaded.');

                log('Attempting to load useHeadlessComponent...');
                const { useHeadlessComponent } = await import(`${basePath}/hooks/use-headless-component.js`);
                if (!useHeadlessComponent) throw new Error("useHeadlessComponent not loaded.");
                log('useHeadlessComponent loaded.');

                const App = () => {
                    const { useEffect } = window.React;
                    const { 
                        component, 
                        componentState, 
                        cssState, 
                        history, 
                        undo, 
                        redo 
                    } = useHeadlessComponent(HeadlessButton);

                    useEffect(() => {
                        const sub = component.subscribe('clicked', () => {
                            log('Button clicked event received!');
                        });
                        return () => sub();
                    }, [component]);
                    
                    useEffect(() => {
                        log(`Button state updated: Disabled=${componentState.isDisabled}, Loading=${componentState.isLoading}`);
                    }, [componentState]);

                    return window.React.createElement(
                        'div', 
                        null,
                        window.React.createElement(
                            'button',
                            { 
                                onClick: (e) => component.click(e),
                                onMouseEnter: (e) => component.hover(true, e),
                                onMouseLeave: (e) => component.hover(false, e),
                                onFocus: (e) => component.focus(true, e),
                                onBlur: (e) => component.focus(false, e),
                                disabled: componentState.isDisabled || componentState.isLoading,
                                style: { 
                                    opacity: componentState.isHovered ? 0.8 : 1,
                                    border: componentState.isFocused ? '2px solid blue' : '1px solid #007bff',
                                    backgroundColor: componentState.isPressed ? '#004085' : '#007bff'
                                 }
                            },
                            componentState.isLoading ? 'Loading...' : 'Click Me (ESM)'
                        ),
                        window.React.createElement('div', { style: { marginTop: '10px' } },
                            window.React.createElement('button', { onClick: () => component.setDisabled(!componentState.isDisabled), style: { marginRight: '5px'} }, 'Toggle Disabled'),
                            window.React.createElement('button', { onClick: () => component.setLoading(!componentState.isLoading) }, 'Toggle Loading')
                        ),
                        window.React.createElement('div', { style: { marginTop: '10px', fontSize: '0.8em' } },
                            window.React.createElement('button', { onClick: undo, disabled: !history.canUndo, style: { marginRight: '5px'} }, 'Undo'),
                            window.React.createElement('button', { onClick: redo, disabled: !history.canRedo }, 'Redo'),
                            ` History: ${history.currentPosition + 1}/${history.length}`
                        ),
                        window.React.createElement('pre', {style: { fontSize: '0.7em', textAlign: 'left', background: '#efefef', padding: '5px', maxHeight: '100px', overflow: 'auto'}}, JSON.stringify({ componentState, cssState }, null, 2))
                    );
                };

                log('Rendering React component...');
                const root = window.ReactDOM.createRoot(document.getElementById('app'));
                root.render(window.React.createElement(App));
                log('React component rendered.');

            } catch (error) {
                log('ERROR in main(): ' + error.message, 'error');
                console.error("Detailed error:", error);
                document.getElementById('app').innerHTML = '<p class="error">Failed to load application. Check console.</p>';
            }
        }

        main();
    </script>
</body>
</html>
