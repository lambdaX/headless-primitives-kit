
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeadlessButton ESM Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background-color: #e9e9e9;
            transition: background-color 0.2s, opacity 0.2s;
        }
        button:hover { background-color: #dcdcdc; }
        button:disabled { cursor: not-allowed; opacity: 0.5; background-color: #f0f0f0; }
        button.pressed { background-color: #c0c0c0; }
        .controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .controls label { margin-right: 10px; }
        .state-display { margin-top: 15px; padding: 10px; background-color: #eee; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 0.9em; }
        .error { color: red; font-weight: bold; }
        .loading { font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>HeadlessButton ESM Example</h1>
        <p>This example loads HeadlessButton and its dependencies directly from a CDN using ES Modules.</p>
        
        <div id="root"></div>

        <div class="controls">
            <h2>Controls for HeadlessButton</h2>
            <button id="toggle-disabled">Toggle Disabled</button>
            <button id="toggle-loading">Toggle Loading</button>
            <button id="toggle-error">Toggle Error</button>
            <button id="undo">Undo</button>
            <button id="redo">Redo</button>
        </div>

        <div class="state-display">
            <h3>Current HeadlessButton State:</h3>
            <pre id="component-state-output">Loading state...</pre>
            <h3>Current CSS State:</h3>
            <pre id="css-state-output">Loading CSS state...</pre>
            <h3>History:</h3>
            <pre id="history-output">Loading history...</pre>
        </div>
    </div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useCallback } from 'https://esm.sh/react@18.3.1';
        import ReactDOM from 'https://esm.sh/react-dom@18.3.1/client';

        // Import HeadlessButton and its dependencies from your published package via jsDelivr
        // Make sure the package name and path are correct (including /dist/ if that's where compiled files are)
        const GITHUB_USER = 'lambdaX';
        const GITHUB_REPO = 'headless-primitives-kit';
        const GITHUB_BRANCH_OR_TAG = 'main'; // Or a specific version tag like 'v0.1.0'

        const baseJsDelivrUrl = `https://cdn.jsdelivr.net/gh/${GITHUB_USER}/${GITHUB_REPO}@${GITHUB_BRANCH_OR_TAG}/dist`;

        // Dynamically import necessary modules. Note the .js extension.
        const { HeadlessButton } = await import(`${baseJsDelivrUrl}/headless-button.js`);
        // HeadlessButton depends on HeadlessComponent, EventEmitter, Command, ComponentState, etc.
        // These will be fetched by the browser as it encounters their imports within headless-button.js
        // For this example, we primarily interact with HeadlessButton itself.

        function useHeadlessComponent(HeadlessComponentClass) {
            const component = useMemo(() => new HeadlessComponentClass(), [HeadlessComponentClass]);
            const [componentState, setComponentState] = useState(component.getState());
            const [cssState, setCssState] = useState(component.getCSSState());
            const [history, setHistory] = useState(component.getHistory());

            useEffect(() => {
                const onStateChanged = (_, newState) => setComponentState(newState);
                const onCssStateChanged = (_, newCssState) => setCssState(newCssState);
                const onHistoryChanged = (_, newHistory) => setHistory(newHistory);

                const unsubState = component.subscribe('stateChanged', onStateChanged);
                const unsubCss = component.subscribe('cssStateChanged', onCssStateChanged);
                const unsubTransition = component.subscribe('stateTransition', () => {
                    setComponentState(component.getState());
                    setCssState(component.getCSSState());
                });
                const unsubHistory = component.subscribe('historyChanged', onHistoryChanged);
                
                // Initial sync
                setComponentState(component.getState());
                setCssState(component.getCSSState());
                setHistory(component.getHistory());

                return () => {
                    unsubState();
                    unsubCss();
                    unsubTransition();
                    unsubHistory();
                };
            }, [component]);

            const undo = useCallback(() => component.undo(), [component]);
            const redo = useCallback(() => component.redo(), [component]);

            return { component, componentState, cssState, history, undo, redo };
        }

        function MyStyledButton({ onActualClick, initialText = "Click Me" }) {
            const { component, componentState, cssState, undo, redo, history } = useHeadlessComponent(HeadlessButton);
            
            // Expose component instance and state for external controls
            useEffect(() => {
                window.myApp = window.myApp || {};
                window.myApp.buttonComponent = component;
                window.myApp.setComponentStateOutput = (state) => {
                    document.getElementById('component-state-output').textContent = JSON.stringify(state, null, 2);
                };
                window.myApp.setCssStateOutput = (state) => {
                    document.getElementById('css-state-output').textContent = JSON.stringify(state, null, 2);
                };
                 window.myApp.setHistoryOutput = (hist) => {
                    document.getElementById('history-output').textContent = JSON.stringify(hist, null, 2);
                };
            }, [component]);

            useEffect(() => {
                if (window.myApp && window.myApp.setComponentStateOutput) {
                    window.myApp.setComponentStateOutput(componentState);
                }
            }, [componentState]);

            useEffect(() => {
                if (window.myApp && window.myApp.setCssStateOutput) {
                    window.myApp.setCssStateOutput(cssState);
                }
            }, [cssState]);

            useEffect(() => {
                if (window.myApp && window.myApp.setHistoryOutput) {
                    window.myApp.setHistoryOutput(history);
                }
            }, [history]);


            useEffect(() => {
                if (!onActualClick) return;
                const handleHeadlessClick = (event, data) => {
                    console.log('Headless button "clicked" event!', data);
                    onActualClick(data?.originalEvent);
                };
                const unsubscribe = component.subscribe('clicked', handleHeadlessClick);
                return () => unsubscribe();
            }, [component, onActualClick]);

            let buttonText = initialText;
            if (componentState.isLoading) buttonText = "Loading...";
            else if (componentState.error) buttonText = "Error!";

            // Simple class application based on cssState for visualization
            let buttonClasses = cssState.classes.join(' ');
            if (componentState.isPressed) buttonClasses += ' pressed';

            return React.createElement('button', {
                type: 'button',
                onClick: (e) => component.click(e),
                onMouseEnter: (e) => component.hover(true, e),
                onMouseLeave: (e) => component.hover(false, e),
                onFocus: (e) => component.focus(true, e),
                onBlur: (e) => component.focus(false, e),
                onKeyDown: (e) => component.keydown(e),
                onMouseDown: () => component.press(true),
                onMouseUp: () => component.press(false),
                disabled: componentState.isDisabled || componentState.isLoading,
                'aria-disabled': componentState.isDisabled || componentState.isLoading,
                className: buttonClasses,
                ...cssState.dataAttributes
            }, buttonText);
        }

        const App = () => {
            return React.createElement('div', null,
                React.createElement(MyStyledButton, { 
                    initialText: "Interactive Button",
                    onActualClick: () => alert('Button was actually clicked!') 
                })
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));

        // Setup external controls
        document.getElementById('toggle-disabled').addEventListener('click', () => {
            if (window.myApp && window.myApp.buttonComponent) {
                const currentDisabled = window.myApp.buttonComponent.getState().isDisabled;
                window.myApp.buttonComponent.setDisabled(!currentDisabled);
            }
        });
        document.getElementById('toggle-loading').addEventListener('click', () => {
            if (window.myApp && window.myApp.buttonComponent) {
                const currentLoading = window.myApp.buttonComponent.getState().isLoading;
                window.myApp.buttonComponent.setLoading(!currentLoading);
            }
        });
        document.getElementById('toggle-error').addEventListener('click', () => {
            if (window.myApp && window.myApp.buttonComponent) {
                const currentError = window.myApp.buttonComponent.getState().error;
                window.myApp.buttonComponent.setError(currentError ? null : 'An example error!');
            }
        });
        document.getElementById('undo').addEventListener('click', () => {
            window.myApp?.buttonComponent?.undo();
        });
        document.getElementById('redo').addEventListener('click', () => {
            window.myApp?.buttonComponent?.redo();
        });

    </script>
</body>
</html>
